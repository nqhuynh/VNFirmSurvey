---
title: "Skill intensity over years"
output: bookdown::pdf_document2 
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(VNFirmSurvey)
library(data.table)
library(ggplot2)
library(DataExplorer)
library(here)
library(haven)
library(labelled)
library(dplyr)
library(labelled)
```

```{r load-data}

dta_list <- list(here("inst", "extdata",
                    "Stata_2001",
                    "dn2001.dta"),
                 here("inst", "extdata",
                    "Stata_2002",
                    "dn2002.dta"),
                 here("inst", "extdata",
                    "Stata_2003",
                    "dn2003.dta"),
                 here("inst", "extdata",
                    "Stata_2004",
                    "dn2004.dta"),
                 here("inst", "extdata",
                    "Stata_2005",
                    "dn2005.dta"),
                 here("inst", "extdata",
                    "Stata_2006",
                    "dn2006.dta"),
                 here("inst", "extdata",
                    "Stata_2007",
                    "dn2007.dta"),
                 here("inst", "extdata",
                    "Stata_2008",
                    "dn2008.dta"),
                 here("inst", "extdata",
                    "Stata_2009",
                    "dn2009.dta"),
                 here("inst", "extdata",
                    "Stata_2010",
                    "dn2010.dta"),
                 here("inst", "extdata",
                    "Stata_2011",
                    "dn2011_mst.dta"),
                 here("inst", "extdata",
                    "Stata_2012",
                    "dn2012_mst.dta"),
                 here("inst", "extdata",
                    "Stata_2013",
                    "dn2013_mst.dta"),
                 here("inst", "extdata",
                    "Stata_2014",
                    "dn2014.dta"),
                 here("inst", "extdata",
                    "Stata_2015",
                    "dn2015.dta"),
                 here("inst", "extdata",
                    "Stata_2016",
                    "dn2016.dta"),
                 here("inst", "extdata",
                    "Stata_2017",
                    "dn2017_new.dta"),
                 here("inst", "extdata",
                    "Stata_2018",
                    "dn2018.dta")
                 )

years <- c(2001:2018)

```

## Plants

About 120000 plants with no district codes. Let's say it takes 5 mins to get 1 plant done. It would take about 7000 hours.

Each week we spend 8\*5 = 40. It would take 173 weeks for 1 person.

If there are 10 people, it would take 18 weeks. If there are 5 people, it would take 34 weeks.

Alternative approaches: 1. What if I do a machine learning where they learn the address of the later years, and then guess the district of the plants? Then I need some people to verify some of these matching Based on the address text and province code.

2.  Only do the last two years, 30000 plants let's say. Then about 100 hours.

```{r load-plant}
plant_list <- list("/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Data_DS_Updated/ds2000.dta",
                       "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Data_DS_Updated/ds2001.dta",
                       "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Data_DS_Updated/ds2002.dta",
                       "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Data_DS_Updated/ds2003.dta",
                       "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Data_DS_Updated/ds2004.dta",
                       "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Data_DS_Updated/ds2005.dta",
                       "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Data_DS_Updated/ds2006.dta", 
                   "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Stata_2007_2009/Stata_2007/ds2007.dta", 
                   "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Stata_2007_2009/Stata_2008/ds2008.dta", 
                   "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Stata_2007_2009/Stata_2009/ds2009.dta", 
                   "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Stata_2010/ds2010.dta", 
                   "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Stata_2011/cs2011.dta", 
                   "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Stata_2012/ds2012.dta", 
                   "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Stata_2013/ds2013.dta", 
                   "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/Data/Stata_2014/ds2014.dta" 
                   )
```

```{r}
years <- c(2000:2014)
plant_data <- plant(dta_list = plant_list, 
          years = years)      

plant_data[is.na(district), .N, by = .(macs, svyear)][N > 1,  sum(N)]

library(writexl)
writexl::write_xlsx(plant_data[svyear == 2009], )

```

## Location

The location codes at district level change from 2004. I need a concodore between these two system

```{r}

location_dta <- getLocation(dta_list, 
                            years = years)

location_dta[svyear == 2001, .(madn, xa, huyen, tinh)]

location_dta[svyear == 2007 & tinh == "01"
             & huyen == "001", .(madn, xa, huyen, tinh)]

```

## Ownership

```{r load-ownership}
ownership_dta <- ownership(dta_list)
```

```{r}
ggplot(ownership_dta[, .N, by = .(svyear, simple_ownership)],
       aes(fill=simple_ownership, y=N, x=svyear)) + 
    geom_bar(position="fill", stat="identity") + 
  theme_classic()

```

## Entry, exit

```{r entry}
geo_dta <- getLocation(dta_list, 
                          years = years)

View(geo_dta)
# 
# saveRDS(geo_dta, 
#         file = "/Volumes/GoogleDrive/My Drive/econ_datasets/Vietnam_VES/cleaned_data/geo_dta.rds")

dynamic_dta <- harmonize_firmID(geo_dta)


dynamic_dta <- EntryExit(dynamic_dta, 
                         base_year = c(2001, 2004), 
                         years= years)

dynamic_dta[!duplicated(firm_id), .N, by = status_2018rel_2004]
```
58598
macs: 69719
without capso: 62491


# Industry code

For 2010, use nganh_kd and nganh_cu to create a cocondorance. Use nganh_kd as the main product code.

```{r}

 # geo_dta[[1]][, .(nganh_kd)]
 #      geo_dta[[3]][, .(nganh_kd, nganh_cu)]
 #      names(geo_dta[[3]])
```


## Orbis

```{r orbis}
orbis_dta <- fread("/Volumes/GoogleDrive/My Drive/papers/conglomerates_and_growth/data/Orbis_Data/vietnam_very_large.csv")


orbis_dta <- orbis_dta[, .(firm_name= `Company name Latin alphabet`, 
              BvD_ID = `BvD ID number`,
              GUO_name = `GUO - Name`,
              GUO_BvD_ID = `GUO - BvD ID number`)
          ][, 
            ma_thue :=  sub('..', '', BvD_ID)
          ]

firm_dta <- geo_dta[svyear == 2018 & ma_thue != "", .(svyear, ma_thue, tinh)]

merged_data <-merge(firm_dta, 
      orbis_dta, 
      by = "ma_thue")[order(ma_thue)]

# 
# temp[ma_thue == "6303000078", .(ma_thue, BvD_ID, 
#                                 check = (ma_thue == sub('..', '', BvD_ID) ))]

```


# Wage Data

```{r load-wage-data}

wage_dta <- getWage(dta_list)
```

```{r wage-distribution}
graph_wage <- merge(wage_dta[, .(svyear, wage_bill_USD)],
                    wage_dta[, .(mean_wage = mean(wage_bill_USD)), 
                       by = svyear], 
                    by = "svyear")

ggplot(graph_wage, aes(x = log(wage_bill_USD), col = factor(svyear))) + 
  geom_density()



```
